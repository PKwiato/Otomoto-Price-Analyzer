<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otomoto Price Analyzer ðŸš€</title>
    <!-- Tailwind CSS (Trendy!) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for that premium feel */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col p-6 overflow-y-auto">
        <h1 class="text-2xl font-bold mb-2 text-blue-500 tracking-tight">ðŸš— Price Analyzer</h1>
        <p class="text-xs text-gray-400 mb-6">Premium Otomoto Analytics</p>

        <!-- Make -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Make</label>
            <select id="makeSelect"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <option>Loading...</option>
            </select>
        </div>

        <!-- Model -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Model</label>
            <select id="modelSelect"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                disabled>
                <option>Select Make first</option>
            </select>
        </div>

        <!-- Generation -->
        <div class="mb-4" id="genContainer" style="display:none;">
            <label class="block text-sm font-medium text-gray-400 mb-1">Generation</label>
            <select id="genSelect"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <option value="">Any</option>
            </select>
        </div>

        <!-- Year Range -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Year Range</label>
            <div class="flex gap-2">
                <input type="number" id="yearFrom" value="2015"
                    class="w-1/2 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-center text-white">
                <input type="number" id="yearTo" value="2024"
                    class="w-1/2 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-center text-white">
            </div>
        </div>

        <!-- New Filters -->
        <div class="grid grid-cols-2 gap-2 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Fuel</label>
                <select id="fuelSelect"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Any</option>
                    <option value="petrol">Petrol</option>
                    <option value="diesel">Diesel</option>
                    <option value="electric">Electric</option>
                    <option value="hybrid">Hybrid</option>
                    <option value="lpg">LPG</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Gearbox</label>
                <select id="gearboxSelect"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Any</option>
                    <option value="automatic">Automatic</option>
                    <option value="manual">Manual</option>
                </select>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Drive Type</label>
            <select id="driveSelect"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Any</option>
                <option value="front-wheel-drive">FWD</option>
                <option value="rear-wheel-drive">RWD</option>
                <option value="4x4">AWD / 4x4</option>
            </select>
        </div>

        <!-- Pagination Control -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Max Pages to Scrape</label>
            <input type="number" id="maxPages" value="500" min="1" max="500"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
            <p class="text-xs text-gray-500 mt-1">Default: All (up to 500)</p>
        </div>

        <!-- Advanced Filters -->
        <!-- ... -->


        <!-- Advanced Filters -->
        <details class="mb-6">
            <summary class="text-sm font-medium text-gray-400 cursor-pointer hover:text-white transition">Advanced
                Filters</summary>
            <div class="mt-3 space-y-3 pl-2 border-l-2 border-gray-700">

                <!-- Accident Free -->
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="accidentFree"
                        class="form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                    <span class="text-sm">Accident Free âœ…</span>
                </label>
                <!-- First Owner -->
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="firstOwner"
                        class="form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                    <span class="text-sm">First Owner ðŸ‘¤</span>
                </label>
            </div>
        </details>

        <button id="searchBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:scale-[1.02] transition-all duration-200">
            Analyze Prices
        </button>

        <div id="statusMsg" class="mt-4 text-xs text-center text-gray-500 animate-pulse hidden">Searching...</div>
    </aside>

    <!-- Main Dashboard -->
    <main class="flex-1 flex flex-col overflow-y-auto bg-gray-900 p-8">

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <p class="text-gray-400 text-sm font-medium uppercase">Average Price</p>
                <p id="avgPrice" class="text-3xl font-bold text-white mt-1">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <p class="text-gray-400 text-sm font-medium uppercase">Median Price</p>
                <p id="medianPrice" class="text-3xl font-bold text-blue-400 mt-1">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <p class="text-gray-400 text-sm font-medium uppercase">Limit Low</p>
                <p id="minPrice" class="text-3xl font-bold text-green-400 mt-1">-</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <p class="text-gray-400 text-sm font-medium uppercase">Limit High</p>
                <p id="maxPrice" class="text-3xl font-bold text-red-400 mt-1">-</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 h-96">
                <h3 class="text-lg font-bold mb-4 text-gray-200">Price Distribution</h3>
                <canvas id="priceDistChart"></canvas>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 h-96">
                <h3 class="text-lg font-bold mb-4 text-gray-200">Price vs. Year</h3>
                <canvas id="priceYearChart"></canvas>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 h-96 md:col-span-2 lg:col-span-2">
                <h3 class="text-lg font-bold mb-4 text-gray-200">Price vs. Mileage</h3>
                <canvas id="priceMileageChart"></canvas>
            </div>
        </div>

        <!-- Results Table -->


    </main>

    <script>
        // --- API & State ---
        const API_BASE = '/api'; // Relative path since served by same origin
        let generations = {}; // Cache generations
        let fetchedListings = []; // Store raw data for client-side filtering

        // --- Charts ---
        let distChart = null;
        let scatterChart = null;
        let mileageChart = null;

        // --- Init ---
        async function init() {
            try {
                const res = await fetch(`${API_BASE}/makes`);
                const makes = await res.json();
                const makeSelect = document.getElementById('makeSelect');
                makeSelect.innerHTML = '<option value="">Select Make</option>';
                makes.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
                    makeSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Failed to load makes", e);
            }

            // Add listeners for client-side filtering
            document.getElementById('yearFrom').addEventListener('input', applyClientFilters);
            document.getElementById('yearTo').addEventListener('input', applyClientFilters);
        }

        // --- Event Listeners ---
        document.getElementById('makeSelect').addEventListener('change', async (e) => {
            const make = e.target.value;
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.disabled = true;
            modelSelect.innerHTML = '<option>Loading...</option>';

            if (!make) return;

            const res = await fetch(`${API_BASE}/models/${make}`);
            const models = await res.json();

            modelSelect.innerHTML = '<option value="">Select Model</option>';
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m; // Model names are usually lowercase slugs or mixed
                modelSelect.appendChild(opt);
            });
            modelSelect.disabled = false;
        });

        document.getElementById('modelSelect').addEventListener('change', async (e) => {
            const model = e.target.value;
            const make = document.getElementById('makeSelect').value;
            const genContainer = document.getElementById('genContainer');
            const genSelect = document.getElementById('genSelect');

            // Fetch generations
            const res = await fetch(`${API_BASE}/generations/${make}/${model}`);
            const text = await res.text();
            // Handle empty response logic if needed
            try {
                const gens = JSON.parse(text);
                if (Object.keys(gens).length > 0) {
                    genContainer.style.display = 'block';
                    genSelect.innerHTML = '<option value="">Any Generation</option>';
                    for (const [label, slug] of Object.entries(gens)) {
                        if (!slug) continue;
                        const opt = document.createElement('option');
                        opt.value = slug;
                        opt.textContent = label;
                        genSelect.appendChild(opt);
                    }
                } else {
                    genContainer.style.display = 'none';
                }
            } catch (e) { genContainer.style.display = 'none'; }
        });

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const btn = document.getElementById('searchBtn');
            const status = document.getElementById('statusMsg');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            status.classList.remove('hidden');
            status.textContent = "Scraping Otomoto... (this may take a while)";

            const payload = {
                make: document.getElementById('makeSelect').value,
                model: document.getElementById('modelSelect').value,
                year_from: parseInt(document.getElementById('yearFrom').value),
                year_to: parseInt(document.getElementById('yearTo').value),
                accident_free: document.getElementById('accidentFree').checked,
                first_owner: document.getElementById('firstOwner').checked,
                max_pages: parseInt(document.getElementById('maxPages').value) || 100,
                fuel_type: document.getElementById('fuelSelect').value || null,
                gearbox: document.getElementById('gearboxSelect').value || null,
                drive_type: document.getElementById('driveSelect').value || null
            };

            // Generation
            const genSlug = document.getElementById('genSelect').value;
            if (genSlug) payload.generation_slug = genSlug;

            try {
                const res = await fetch(`${API_BASE}/listings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Search failed");
                const data = await res.json();

                fetchedListings = data.listings;
                applyClientFilters();
                status.textContent = `Found ${data.count} listings`;
            } catch (e) {
                status.textContent = "Error: " + e.message;
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        });

        function updateDashboard(listings) {
            // 1. Stats
            const prices = listings.map(l => l.price).filter(p => p > 0);
            if (prices.length) {
                document.getElementById('avgPrice').textContent = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length).toLocaleString() + " PLN";
                document.getElementById('minPrice').textContent = Math.min(...prices).toLocaleString() + " PLN";
                document.getElementById('maxPrice').textContent = Math.max(...prices).toLocaleString() + " PLN";

                const sorted = [...prices].sort((a, b) => a - b);
                const median = sorted[Math.floor(sorted.length / 2)];
                document.getElementById('medianPrice').textContent = median.toLocaleString() + " PLN";
            }

            // 2. Table (Removed)

            // 3. Charts
            updateCharts(listings);
        }

        function updateCharts(listings) {
            // Price Dist
            const prices = listings.filter(l => l.price > 0).map(l => l.price);
            // Simple bins
            const binCount = 10;
            const min = Math.min(...prices);
            const max = Math.max(...prices);
            const step = (max - min) / binCount;
            const bins = new Array(binCount).fill(0);
            const labels = [];

            for (let i = 0; i < binCount; i++) {
                labels.push(`${Math.round(min + i * step) / 1000}k`);
            }

            prices.forEach(p => {
                const idx = Math.min(Math.floor((p - min) / step), binCount - 1);
                bins[idx]++;
            });

            if (distChart) distChart.destroy();
            distChart = new Chart(document.getElementById('priceDistChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: bins,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#374151' } },
                        x: { grid: { color: '#374151' } }
                    }
                }
            });

            // Price vs Year
            const scatterData = listings.filter(l => l.year && l.price).map(l => ({ x: parseInt(l.year), y: l.price }));

            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(document.getElementById('priceYearChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Listing',
                        data: scatterData,
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Year' },
                            grid: { color: '#374151' },
                            ticks: {
                                stepSize: 1,
                                callback: function (value) { return value.toString(); }
                            }
                        },
                        y: { grid: { color: '#374151' } }
                    }
                }
            });

            // Price vs Mileage
            const mileageData = listings
                .filter(l => l.mileage && l.price && l.mileage > 0)
                .map(l => ({ x: l.mileage, y: l.price }));

            if (mileageChart) mileageChart.destroy();
            mileageChart = new Chart(document.getElementById('priceMileageChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Listing',
                        data: mileageData,
                        backgroundColor: '#10b981' // Emerald-500
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Mileage (km)' },
                            grid: { color: '#374151' },
                            ticks: {
                                callback: function (value) { return (value / 1000).toFixed(0) + 'k'; }
                            }
                        },
                        y: {
                            grid: { color: '#374151' },
                            title: { display: true, text: 'Price (PLN)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Price: ${context.parsed.y} PLN, Mileage: ${context.parsed.x} km`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function applyClientFilters() {
            if (!fetchedListings.length) return;

            const yFrom = parseInt(document.getElementById('yearFrom').value) || 1900;
            const yTo = parseInt(document.getElementById('yearTo').value) || 2100;

            // Filter by year
            const filtered = fetchedListings.filter(l => {
                const y = parseInt(l.year);
                return y >= yFrom && y <= yTo;
            });

            updateDashboard(filtered);
        }

        // Start
        init();
    </script>
</body>

</html>